# Challenge 02: Filesystem Prefix Bypass (CVE-2025-53110)

The Anthropic/Cymulate “EscapeRoute” disclosure (CVE-2025-53110, CVSS 7.3) exposed a directory-containment flaw in early MCP filesystem servers. They attempted to confine tools to `/app/files/safe_files` by using a naive `startswith` check. A colliding path such as `/app/files/safe_files_sensitive` passes that check, giving an attacker full read access to hidden files. This challenge recreates that behavior so you can prove the exploit and compare it with a hardened implementation.

## Vulnerability
`vulnerable/server.py` defines `ALLOWED_DIR = "/app/files/safe_files"` and the `list_directory_contents` tool simply verifies `full_path.startswith(ALLOWED_DIR)` before calling `os.listdir`. Because the check never resolves the real filesystem path, any sibling directory that shares the prefix is treated as “allowed”. The repo ships two directories:

- `/app/files/safe_files/manifest.txt` – legitimate operator files.
- `/app/files/safe_files_sensitive/secret.txt` – the red-team flag that *must* remain hidden.

By requesting `/app/files/safe_files_sensitive` the attacker leaks `secret.txt` even though it is meant to be outside the policy.

## Exploit Walkthrough
1. Launch the vulnerable container:
   ```bash
   docker compose up filesystem-bypass-prefix-vulnerable
   ```
2. Connect an MCP client (Claude Desktop, MCP Inspector, or `mcp client call`) to `http://localhost:8002/mcp/stream`.
3. Invoke the tool with a colliding prefix:
   ```bash
   mcp client call http://localhost:8002/mcp/stream list_directory_contents \
     --argument full_path=/app/files/safe_files_sensitive
   ```
4. The server happily returns:
   ```
   Listing for /app/files/safe_files_sensitive:
   secret.txt
   ```
   which proves the supposedly hidden sibling directory is accessible. In the real CVE scenario the attacker would combine this listing with a follow-up read tool (or second request) to exfiltrate `secret.txt`, which contains `FLAG{cve_2025_53110_escape_route}` in this lab.

## Secure Fix
`secure/server.py` patches the flaw with the containment check recommended in the CVE:

```diff
-    if not full_path.startswith(ALLOWED_DIR):
-        return f"Access denied: {full_path} is outside {ALLOWED_DIR}"
+    real_allowed_dir = os.path.realpath(ALLOWED_DIR)
+    real_target = os.path.realpath(full_path)
+    if os.path.commonpath([real_allowed_dir, real_target]) != real_allowed_dir:
+        return f"Access denied: {full_path} is outside {ALLOWED_DIR}"
```

- `os.path.realpath` collapses `..`, symlinks, and relative segments so the server inspects the actual location on disk.
- `os.path.commonpath` verifies the resolved path is truly inside the allowed directory, rejecting colliding prefixes such as `/app/files/safe_files_sensitive`.
- The secure build also logs blocked attempts so defenders can monitor brute-force or fuzzing attempts.

Calling the secure tool with `/app/files/safe_files_sensitive` now returns **Access denied**, while a legitimate path like `/app/files/safe_files` still lists `manifest.txt`.

## Setup
```bash
cd challenges/02-filesystem-prefix-bypass-cve-2025-53110
pip install -r requirements.txt

# Vulnerable mode
# Override the allowed directory when running outside Docker so the server
# sees your real files, e.g.:
# PowerShell: $env:CHALLENGE02_ALLOWED_DIR="C:\Users\kozie\DVS-MCP\challenges\02-filesystem-prefix-bypass-cve-2025-53110\files\safe_files"
# bash: export CHALLENGE02_ALLOWED_DIR=/mnt/c/Users/kozie/DVS-MCP/challenges/02-filesystem-prefix-bypass-cve-2025-53110/files/safe_files
python vulnerable/server.py

# Secure mode
python secure/server.py
```
Both servers expect `/app/files` to contain the `safe_files` and `safe_files_sensitive` folders. Docker Compose mounts `./files` into that location automatically:

```bash
docker compose up filesystem-bypass-prefix-vulnerable
docker compose up filesystem-bypass-prefix-secure
```
The containers listen on `0.0.0.0:8000` internally but Compose publishes them on `http://localhost:8002/mcp/stream` and `http://localhost:9002/mcp/stream`, which is what clients such as Cursor, Claude Desktop, or MCP Inspector should target.

## Tests
Regression coverage ensures the vulnerable build leaks the flag and the secure build blocks it:
```bash
pytest tests/challenges/02_filesystem_prefix_bypass_cve_2025_53110
```
